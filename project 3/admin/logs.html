<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Mall - View Logs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold">Super Mall - Admin Panel</h1>
                <div class="flex gap-4">
                    <a href="dashboard.html" class="hover:text-blue-200">Dashboard</a>
                    <a href="../index.html" class="hover:text-blue-200">Home</a>
                    <button onclick="handleLogout()" class="hover:text-blue-200">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">System Logs</h1>
            <div class="flex gap-4">
                <select id="level-filter" class="border border-gray-300 rounded-md px-3 py-2">
                    <option value="">All Levels</option>
                    <option value="info">Info</option>
                    <option value="warning">Warning</option>
                    <option value="error">Error</option>
                </select>
                <select id="module-filter" class="border border-gray-300 rounded-md px-3 py-2">
                    <option value="">All Modules</option>
                    <option value="AuthService">AuthService</option>
                    <option value="ShopService">ShopService</option>
                    <option value="OfferService">OfferService</option>
                    <option value="CategoryService">CategoryService</option>
                </select>
                <button onclick="loadLogs()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    Refresh
                </button>
            </div>
        </div>

        <!-- Logs Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Level</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Module</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Logs will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="no-logs" class="hidden text-center py-8 text-gray-500">
            No logs found.
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/logger.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        // Initialize auth and check admin access
        authService.init().then(() => {
            if (!authService.requireAdmin()) return;
            loadLogs();
            
            document.getElementById('level-filter').addEventListener('change', loadLogs);
            document.getElementById('module-filter').addEventListener('change', loadLogs);
        });

        async function handleLogout() {
            await authService.signOut();
            window.location.href = '../index.html';
        }

        async function loadLogs() {
            try {
                const levelFilter = document.getElementById('level-filter').value;
                const moduleFilter = document.getElementById('module-filter').value;
                
                let query = firebase.firestore().collection('logs').orderBy('timestamp', 'desc').limit(100);
                
                const snapshot = await query.get();
                const tbody = document.getElementById('logs-table-body');
                const noLogs = document.getElementById('no-logs');
                
                let logs = [];
                snapshot.forEach(doc => {
                    const log = { id: doc.id, ...doc.data() };
                    if ((!levelFilter || log.level === levelFilter) && 
                        (!moduleFilter || log.module === moduleFilter)) {
                        logs.push(log);
                    }
                });

                if (logs.length === 0) {
                    tbody.innerHTML = '';
                    noLogs.classList.remove('hidden');
                    return;
                }

                noLogs.classList.add('hidden');
                tbody.innerHTML = logs.map(log => {
                    const levelColor = log.level === 'error' ? 'text-red-600' : 
                                     log.level === 'warning' ? 'text-yellow-600' : 
                                     'text-blue-600';
                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${log.timestamp ? formatDate(log.timestamp) : 'N/A'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="${levelColor} font-semibold">${log.level || 'info'}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.module || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${log.action || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.userId || 'N/A'}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">
                                <details class="cursor-pointer">
                                    <summary class="text-blue-600 hover:text-blue-800">View Details</summary>
                                    <pre class="mt-2 text-xs bg-gray-100 p-2 rounded">${JSON.stringify(log.details || {}, null, 2)}</pre>
                                </details>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading logs:', error);
                showNotification('Failed to load logs', 'error');
            }
        }
    </script>
</body>
</html>

